name: Publish Python ğŸ distributions ğŸ“¦ to PyPI

on:
  push:
    tags:
      - '*|*'  # Match pattern for tags like airless-captcha:v0.21.2

jobs:
  build-n-publish:
    name: Build and publish Python ğŸ distributions ğŸ“¦ to PyPI
    runs-on: ubuntu-latest
    steps:
    - name: Parse tag and package
      id: tag_split
      run: |
        tag_name=${GITHUB_REF#refs/tags/}
        package_name=$(echo $tag_name | cut -d "|" -f 1)
        version=$(echo $tag_name | cut -d "|" -f 2)
        echo "Package: $package_name"
        echo "Version: $version"
        echo "::set-output name=package::$package_name"
        echo "::set-output name=version::$version"
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    - name: Install pypa/setuptools
      run: |
        python -m pip install -r requirements-dev.txt
    - name: Build a binary wheel
      run: |
        cd packages/${{ steps.tag_split.outputs.package }}
        python -m build
    - name: Publish distribution ğŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: packages/${{ steps.tag_split.outputs.package }}/dist
    - name: Extract changelog for package
      id: changelog
      run: |
        changelog=$(awk '/^\*\*v[0-9]+\.[0-9]+\.[0-9]+\*\*/{p=0}p;/^\*\*v'${{ steps.tag_split.outputs.version }}'\*\*/{p=1}' packages/${{ steps.tag_split.outputs.package }}/CHANGELOG.md)
        echo "::set-output name=changelog::$changelog"
    - name: Create GitHub Release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ steps.tag_split.outputs.package }} v${{ steps.tag_split.outputs.version }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../overview/">
      
      
        <link rel="next" href="../simple/">
      
      
      <link rel="icon" href="../../../assets/images/logo_resized.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.40">
    
    
      
        <title>Core Infrastructure - Airless</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-airless-core-infrastructure-on-gcp-with-terraform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Airless" class="md-header__button md-logo" aria-label="Airless" data-md-component="logo">
      
  <img src="../../../assets/images/logo_white_resized.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Airless
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Core Infrastructure
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  Airless

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../quickstart/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../api/airless-core/operator/" class="md-tabs__link">
          
  
  Api Reference

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Airless" class="md-nav__button md-logo" aria-label="Airless" data-md-component="logo">
      
  <img src="../../../assets/images/logo_white_resized.png" alt="logo">

    </a>
    Airless
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Airless
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Airless
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../infrastucture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart Workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../multistep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi Step Workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Providers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Providers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_1" id="__nav_2_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Google Cloud
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_1">
            <span class="md-nav__icon md-icon"></span>
            Google Cloud
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Core Infrastructure
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Core Infrastructure
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-airless-core-infrastructure-on-gcp-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Building Airless Core Infrastructure on GCP with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building Airless Core Infrastructure on GCP with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-use-google-cloud-functions-in-airless" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use Google Cloud Functions in Airless?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-use-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use Terraform?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-need-for-_raw-storage" class="md-nav__link">
    <span class="md-ellipsis">
      The Need for _raw Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-module-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Module Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-project-setup-backendtf-etc" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Project Setup (backend.tf, etc.)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-function-importance" class="md-nav__link">
    <span class="md-ellipsis">
      Core Function Importance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-code-for-airless-core-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Code for Airless Core Infrastructure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Code for Airless Core Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-structure-for-the-module" class="md-nav__link">
    <span class="md-ellipsis">
      File Structure for the Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variablestf" class="md-nav__link">
    <span class="md-ellipsis">
      variables.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncoremainpy-example-entry-point" class="md-nav__link">
    <span class="md-ellipsis">
      function/core/main.py (Example Entry Point)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncorerequirementstxt-example-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      function/core/requirements.txt (Example Dependencies)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storagetf" class="md-nav__link">
    <span class="md-ellipsis">
      storage.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errortf" class="md-nav__link">
    <span class="md-ellipsis">
      error.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delaytf" class="md-nav__link">
    <span class="md-ellipsis">
      delay.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redirecttf" class="md-nav__link">
    <span class="md-ellipsis">
      redirect.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emailtf" class="md-nav__link">
    <span class="md-ellipsis">
      email.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slacktf" class="md-nav__link">
    <span class="md-ellipsis">
      slack.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outputtf" class="md-nav__link">
    <span class="md-ellipsis">
      output.tf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simple Workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multistep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multistep Workflow
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Api Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Api Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            airless-core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-core/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-core/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-core/service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-core/dto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-core/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-google-cloud-core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            airless-google-cloud-core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1" >
        
          
          <label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-core/core/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    pubsub
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            pubsub
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-core/pubsub/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-google-cloud-storage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            airless-google-cloud-storage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-storage/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-storage/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-google-cloud-bigquery
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            airless-google-cloud-bigquery
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-bigquery/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-bigquery/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-google-cloud-secret-manager
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            airless-google-cloud-secret-manager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-secret-manager/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-google-cloud-vertexai
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            airless-google-cloud-vertexai
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-google-cloud-vertexai/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-slack
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            airless-slack
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-slack/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-slack/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-email
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            airless-email
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-email/operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-email/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-captcha
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            airless-captcha
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-captcha/providers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    providers
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_10" >
        
          
          <label class="md-nav__link" for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    airless-pdf
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            airless-pdf
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/airless-pdf/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-airless-core-infrastructure-on-gcp-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Building Airless Core Infrastructure on GCP with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building Airless Core Infrastructure on GCP with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-use-google-cloud-functions-in-airless" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use Google Cloud Functions in Airless?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-use-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use Terraform?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-need-for-_raw-storage" class="md-nav__link">
    <span class="md-ellipsis">
      The Need for _raw Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-module-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Module Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-project-setup-backendtf-etc" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Project Setup (backend.tf, etc.)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-function-importance" class="md-nav__link">
    <span class="md-ellipsis">
      Core Function Importance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-code-for-airless-core-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Code for Airless Core Infrastructure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Code for Airless Core Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-structure-for-the-module" class="md-nav__link">
    <span class="md-ellipsis">
      File Structure for the Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variablestf" class="md-nav__link">
    <span class="md-ellipsis">
      variables.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncoremainpy-example-entry-point" class="md-nav__link">
    <span class="md-ellipsis">
      function/core/main.py (Example Entry Point)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncorerequirementstxt-example-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      function/core/requirements.txt (Example Dependencies)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storagetf" class="md-nav__link">
    <span class="md-ellipsis">
      storage.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errortf" class="md-nav__link">
    <span class="md-ellipsis">
      error.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delaytf" class="md-nav__link">
    <span class="md-ellipsis">
      delay.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redirecttf" class="md-nav__link">
    <span class="md-ellipsis">
      redirect.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emailtf" class="md-nav__link">
    <span class="md-ellipsis">
      email.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slacktf" class="md-nav__link">
    <span class="md-ellipsis">
      slack.tf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outputtf" class="md-nav__link">
    <span class="md-ellipsis">
      output.tf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Core Infrastructure</h1>

<h2 id="building-airless-core-infrastructure-on-gcp-with-terraform">Building Airless Core Infrastructure on GCP with Terraform</h2>
<p>This guide explains how to set up the essential GCP resources for an Airless workflow orchestrator using Terraform. Airless leverages serverless functions and message queues to create scalable, event-driven workflows.</p>
<h3 id="why-use-google-cloud-functions-in-airless">Why Use Google Cloud Functions in Airless?</h3>
<p>Airless is designed around a serverless, event-driven architecture. Google Cloud Functions are a natural fit for this model in GCP for several reasons outlined in the Airless philosophy:</p>
<ol>
<li><strong>Serverless:</strong> Cloud Functions eliminate the need to manage underlying servers or infrastructure. You only pay for execution time, which is cost-effective, especially for workflows that aren't running constantly. This aligns with Airless's goal to avoid the fixed costs and management overhead of traditional orchestrators like a dedicated Airflow instance.</li>
<li><strong>Scalability:</strong> Cloud Functions automatically scale based on the incoming event load (e.g., messages in a Pub/Sub topic). This handles the "massive parallel processing" requirement mentioned for Airless, particularly for use cases like data scraping where the number of tasks can vary dramatically and unpredictably.</li>
<li><strong>Event-Driven:</strong> Functions are triggered by events, such as messages published to a Pub/Sub topic or HTTP requests. This fits perfectly with Airless's data flow where tasks trigger subsequent tasks by publishing messages.</li>
<li><strong>Decoupling:</strong> Using functions triggered by queues (Pub/Sub) decouples different stages of a workflow. Each function performs a specific task and communicates with others via messages, enhancing resilience and modularity.</li>
</ol>
<h3 id="why-use-terraform">Why Use Terraform?</h3>
<p>Terraform is an Infrastructure as Code (IaC) tool used to define and provision infrastructure resources across various cloud providers, including GCP. Using Terraform for Airless offers significant advantages:</p>
<ol>
<li><strong>Reproducibility &amp; Consistency:</strong> Define your entire Airless infrastructure (Functions, Pub/Sub topics, Storage Buckets, etc.) in configuration files. This ensures you can create identical environments (dev, staging, prod) consistently.</li>
<li><strong>Version Control:</strong> Store your infrastructure configuration in version control systems (like Git). Track changes, collaborate with others, and roll back to previous states if needed.</li>
<li><strong>Automation:</strong> Automate the provisioning and management of your GCP resources, reducing manual effort and the potential for human error.</li>
<li><strong>Modularity:</strong> Break down your infrastructure into reusable modules (as demonstrated in the provided code), making configurations easier to manage and scale.</li>
<li><strong>State Management:</strong> Terraform keeps track of the resources it manages in a state file, allowing it to understand dependencies and manage updates or deletions safely.</li>
</ol>
<h3 id="the-need-for-_raw-storage">The Need for <code>_raw</code> Storage</h3>
<p>In data processing pipelines like those often built with Airless, it's crucial to have intermediate storage layers. The <code>_raw</code> storage bucket (e.g., <code>${var.env}-datalake-raw</code> in <code>storage.tf</code>) serves several key purposes:</p>
<ol>
<li><strong>Error Handling &amp; Debugging:</strong> When a function fails processing a message, the original message data and error details can be stored in the <code>_raw</code> bucket (or a dedicated error location). This prevents data loss and allows for later analysis and reprocessing. The Error function often coordinates this.</li>
<li><strong>Data Staging:</strong> Functions might fetch data that needs to be temporarily stored before being processed by a subsequent task or loaded into a final destination. The <code>_raw</code> or <code>_landing_tmp</code> buckets act as these staging areas.</li>
<li><strong>Auditing &amp; Compliance:</strong> Storing raw incoming data or intermediate results can be necessary for auditing or compliance purposes.</li>
<li><strong>Decoupling Processing:</strong> Allows tasks to deposit data without needing immediate processing by the next step, further decoupling the workflow.</li>
</ol>
<p>The provided <code>storage.tf</code> also includes lifecycle rules to transition older data to cheaper storage classes (like ARCHIVE), managing costs effectively.</p>
<h3 id="terraform-module-structure">Terraform Module Structure</h3>
<p>The provided Terraform code is structured as a <strong>module</strong>. This is a best practice in Terraform that promotes reusability and organization. A module is a self-contained package of Terraform configurations that manages a set of related resources.</p>
<ul>
<li><strong>Inputs:</strong> The module defines input variables (<code>variables.tf</code>) like <code>project_id</code>, <code>region</code>, <code>env</code>, etc. This allows users of the module to customize the deployment without modifying the core code.</li>
<li><strong>Resources:</strong> The module contains the resource definitions (<code>.tf</code> files like <code>error.tf</code>, <code>delay.tf</code>, <code>storage.tf</code>, etc.) that create the actual infrastructure (Cloud Functions, Pub/Sub topics, GCS buckets).</li>
<li><strong>Outputs:</strong> The module defines outputs (<code>output.tf</code>) like bucket names and Pub/Sub topic names/IDs. These outputs expose key information about the created resources, which can be used by other Terraform configurations or for reference.</li>
</ul>
<p>By using a module, you can easily deploy this core Airless infrastructure multiple times (e.g., for different environments or projects) with different configurations by simply calling the module and providing the appropriate input variables.</p>
<h3 id="terraform-project-setup-backendtf-etc">Terraform Project Setup (<code>backend.tf</code>, etc.)</h3>
<p>When using Terraform, you typically organize your code into several files. While the provided code represents a module, a typical Terraform project using this module would also include:</p>
<ol>
<li><strong><code>main.tf</code> (Root):</strong> This file would define the provider (Google Cloud) and call the Airless core module, passing the required input variables.</li>
<li><strong><code>variables.tf</code> (Root):</strong> Defines variables for the root configuration (potentially passing them down to the module).</li>
<li><strong><code>outputs.tf</code> (Root):</strong> Defines outputs for the overall deployment (potentially exposing module outputs).</li>
<li><strong><code>backend.tf</code>:</strong> This crucial file configures Terraform's state management. It tells Terraform where to store the state file, which tracks the resources managed by the configuration. Using a remote backend (like a GCS bucket) is highly recommended for collaboration and consistency.</li>
</ol>
<details class="example">
<summary>Example <code>backend.tf</code> and Root <code>main.tf</code></summary>
<p><strong><code>backend.tf</code></strong>
<div class="highlight"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;gcs&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;your-terraform-state-bucket-name&quot;</span><span class="c1"> # Needs to be created beforehand</span>
<span class="w">    </span><span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;airless/core/dev&quot;</span><span class="c1">                 # Path within the bucket for this state</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p><strong><code>provider.tf</code></strong>
<div class="highlight"><pre><span></span><code><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;google&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">region</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="p">}</span>
</code></pre></div></p>
<p><strong>Root <code>main.tf</code></strong>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_storage_bucket&quot;</span><span class="w"> </span><span class="nv">&quot;function_code_bucket&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-airless-function-code&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="p">}</span>

<span class="c1"># Example of creating a topic needed by the error function</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;pubsub_to_bq&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-pubsub-to-bq&quot;</span>
<span class="p">}</span>

<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;airless_core&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/airless-core&quot;</span><span class="c1"> # Or path/URL to your module</span>

<span class="w">  </span><span class="na">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">region</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">env</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="na">log_level</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>

<span class="w">  </span><span class="nb">function_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.function_code_bucket.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.function_code_bucket.name</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">queue_topic_pubsub_to_bq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.pubsub_to_bq.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.pubsub_to_bq.name</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">source_archive_exclude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;*.pyc&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></p>
</details>
<h3 id="core-function-importance">Core Function Importance</h3>
<p>The Airless core infrastructure includes several specialized functions. Their importance generally follows this hierarchy:</p>
<ol>
<li><strong>Error Function (<code>error.tf</code>):</strong> This is arguably the <strong>most critical</strong> function. It acts as a centralized sink for all errors occurring in other functions. Its responsibilities include logging the error details (to BigQuery via another queue/function or Google Cloud Storage in the <code>_raw</code> bucket), implementing retry logic (using the Delay function), and triggering notifications. Without robust error handling, workflows become brittle and prone to data loss.</li>
<li><strong>Delay Function (<code>delay.tf</code>) &amp; Redirect Function (<code>redirect.tf</code>):</strong> These enable core workflow patterns.<ul>
<li><strong>Delay:</strong> Allows introducing controlled pauses in a workflow (e.g., for rate limiting, waiting for long external processes, or implementing exponential backoff for retries directed by the Error function).</li>
<li><strong>Redirect:</strong> Enables fanning out tasks. A single message can be duplicated and sent to multiple different downstream topics/functions, facilitating parallel processing and complex branching logic.</li>
</ul>
</li>
<li><strong>Email (<code>email.tf</code>) &amp; Slack (<code>slack.tf</code>) Notification Functions:</strong> These are primarily for monitoring and alerting. While important for operational visibility, the core workflow can often function without them (though you wouldn't know if something went wrong!). They decouple the notification logic (SMTP details, Slack API tokens) from the business logic functions, making the system cleaner. They are often triggered by the Error function or at specific success/milestone points in a workflow.</li>
</ol>
<h2 id="terraform-code-for-airless-core-infrastructure">Terraform Code for Airless Core Infrastructure</h2>
<p>Below is the Terraform code based on the files you provided, structured as a module, along with explanations.</p>
<h3 id="file-structure-for-the-module">File Structure for the Module</h3>
<div class="highlight"><pre><span></span><code>modules/
 airless-core/
     main.tf
     variables.tf
     outputs.tf
     storage.tf
     error.tf
     delay.tf
     redirect.tf
     email.tf
     slack.tf
     function/       # Directory containing function source
         core/
             main.py
             requirements.txt
             ... # Other Python code/dependencies
</code></pre></div>
<hr />
<h3 id="variablestf"><code>variables.tf</code></h3>
<ul>
<li>Defines the inputs required by the module. This makes the module configurable.</li>
<li>Includes essential parameters like GCP <code>project_id</code>, <code>region</code>, <code>env</code> (environment name like 'dev' or 'prod'), <code>log_level</code>, buckets for function code and data (<code>function_bucket</code>, implicitly created <code>datalake_*</code>), error handling configuration (<code>error_config</code>), and dependencies like external queues (<code>queue_topic_pubsub_to_bq</code>).</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/variables.tf</span><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;project_id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GCP Project ID where resources will be deployed.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;region&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GCP Region to create the resources in.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;env&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Deployment environment (e.g., &#39;dev&#39;, &#39;staging&#39;, &#39;prod&#39;). Used as a prefix for resource names.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;log_level&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Default log level for Cloud Functions (e.g., &#39;DEBUG&#39;, &#39;INFO&#39;, &#39;WARNING&#39;).&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;function_bucket&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Bucket object containing the ID and name for storing Cloud Function source code zip files.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;queue_topic_pubsub_to_bq&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Pub/Sub topic object (id, name) used by the Error function to send structured error logs, potentially to a BigQuery sink.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;source_archive_exclude&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Set of file patterns to exclude when creating the function source code zip archive.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">set</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;*.pyc&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;error_config&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Configuration for error handling, including BigQuery logging, email, and Slack notifications.&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">    </span><span class="na">bigquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">      </span><span class="na">dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">      </span><span class="na">table</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">      </span><span class="na">sender</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">      </span><span class="na">recipients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="na">slack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">object</span><span class="p">({</span>
<span class="w">      </span><span class="na">channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="maintf"><code>main.tf</code></h3>
<ul>
<li>This file handles the packaging and uploading of the Cloud Function source code.</li>
<li><code>data "archive_file" "source_core"</code>: Zips the contents of the <code>../function/core</code> directory (relative to this <code>main.tf</code> file). It excludes files matching patterns in <code>var.source_archive_exclude</code>. The <code>output_path</code> is a temporary location for the zip file.</li>
<li><code>resource "google_storage_bucket_object" "zip_core"</code>: Uploads the generated zip file (<code>data.archive_file.source_core.output_path</code>) to the GCS bucket specified by <code>var.function_bucket.name</code>. The object name includes the MD5 hash of the zip file (<code>data.archive_file.source_core.output_md5</code>) to ensure that changes in the source code result in a new object, triggering function updates.</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/main.tf</span><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;archive_file&quot;</span><span class="w"> </span><span class="nv">&quot;source_core&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;zip&quot;</span>
<span class="c1">  # Assumes your Python code for the core functions is in ./function/core/</span>
<span class="w">  </span><span class="na">source_dir</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.module}/function/core&quot;</span>
<span class="w">  </span><span class="na">output_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/tmp/function-core-${var.env}.zip&quot;</span><span class="c1"> # Use a unique temp path</span>
<span class="w">  </span><span class="na">excludes</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.source_archive_exclude</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_storage_bucket_object&quot;</span><span class="w"> </span><span class="nv">&quot;zip_core&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">data.archive_file.source_core.output_path</span>
<span class="w">  </span><span class="na">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application/zip&quot;</span>
<span class="c1">  # Name includes hash to trigger updates when code changes</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;src/core-${data.archive_file.source_core.output_md5}.zip&quot;</span>
<span class="w">  </span><span class="na">bucket</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>

<span class="c1">  # Ensure the archive is created before trying to upload</span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">data.archive_file.source_core</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><em>Note: Ensure the <code>function/core</code> directory exists adjacent to your module's <code>.tf</code> files and contains <code>main.py</code>, <code>requirements.txt</code>, and any other necessary Python code.</em></p>
<h3 id="functioncoremainpy-example-entry-point"><code>function/core/main.py</code> (Example Entry Point)</h3>
<ul>
<li>This Python code is the entry point for <em>all</em> the core Cloud Functions defined in this module.</li>
<li>It uses an environment variable <code>OPERATOR_IMPORT</code> (set in the Terraform resource definitions) to dynamically import the correct Airless operator class for the specific function (e.g., <code>GoogleErrorReprocessOperator</code>, <code>GoogleDelayOperator</code>).</li>
<li>The <code>route</code> function is triggered by the Cloud Event (e.g., Pub/Sub message) and calls the <code>run</code> method of the dynamically loaded operator instance.</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/function/core/main.py</span><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">functions_framework</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">airless.core.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_config</span>

<span class="c1"># Dynamically import the operator based on environment variable</span>
<span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;OPERATOR_IMPORT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> as OperatorClass&#39;</span><span class="p">)</span>

<span class="nd">@functions_framework</span><span class="o">.</span><span class="n">cloud_event</span>
<span class="k">def</span><span class="w"> </span><span class="nf">route</span><span class="p">(</span><span class="n">cloud_event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cloud Function entry point triggered by a Pub/Sub event.</span>
<span class="sd">    Dynamically routes the event to the appropriate Airless operator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Instantiate the dynamically loaded operator class</span>
    <span class="n">operator_instance</span> <span class="o">=</span> <span class="n">OperatorClass</span><span class="p">()</span>
    <span class="c1"># Run the operator with the incoming event data</span>
    <span class="n">operator_instance</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cloud_event</span><span class="p">)</span>
</code></pre></div>
<h3 id="functioncorerequirementstxt-example-dependencies"><code>function/core/requirements.txt</code> (Example Dependencies)</h3>
<ul>
<li>Lists the Python packages required by the core functions. These will be installed when GCP builds the function environment.</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/function/core/requirements.txt</span><pre><span></span><code>airless-google-cloud-secret-manager~=0.1.0
airless-google-cloud-storage~=0.1.0
airless-google-cloud-bigquery~=0.1.0
airless-slack~=0.1.0
airless-email~=0.1.0
</code></pre></div>
<hr />
<h3 id="storagetf"><code>storage.tf</code></h3>
<ul>
<li>Defines the Google Cloud Storage (GCS) buckets.</li>
<li><code>google_storage_bucket</code>: Creates buckets for different data stages:<ul>
<li><code>raw</code>: For storing raw/error data, potentially with lifecycle rules.</li>
<li><code>landing</code>: Main landing zone for incoming data.</li>
</ul>
</li>
<li><code>lifecycle_rule</code>: Automatically manages objects in the bucket (e.g., moves objects older than 30 days to ARCHIVE storage class to save costs).</li>
<li><code>force_destroy = false</code>: A safety measure to prevent accidental deletion of buckets containing data when running <code>terraform destroy</code>. Set to <code>true</code> only for temporary/test buckets.</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/storage.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_storage_bucket&quot;</span><span class="w"> </span><span class="nv">&quot;datalake_raw&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-datalake-raw&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # Example Lifecycle Rule: Move data to Archive after 30 days</span>
<span class="w">  </span><span class="nb">lifecycle_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="c1"> # Number of days</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">action</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SetStorageClass&quot;</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ARCHIVE&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_storage_bucket&quot;</span><span class="w"> </span><span class="nv">&quot;datalake_landing&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-datalake-landing&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # Example Lifecycle Rule: Move data to Archive after 30 days</span>
<span class="w">  </span><span class="nb">lifecycle_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">action</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SetStorageClass&quot;</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ARCHIVE&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="errortf"><code>error.tf</code></h3>
<ul>
<li>Defines the critical Error Handling function and its trigger topic.</li>
<li><code>google_pubsub_topic "error_reprocess"</code>: Creates the Pub/Sub topic where other functions will send messages when they encounter errors.</li>
<li><code>google_cloudfunctions2_function "error_reprocess"</code>: Defines the Cloud Function itself.<ul>
<li><code>build_config</code>: Specifies the runtime (<code>python312</code>), entry point (<code>route</code> in <code>main.py</code>), and the source code location (the <code>zip_core</code> object uploaded in <code>main.tf</code>).</li>
<li><code>service_config</code>: Configures runtime settings like memory (<code>256Mi</code>), timeout (<code>540s</code>), and crucial <code>environment_variables</code>:<ul>
<li><code>ENV</code>, <code>GCP_PROJECT</code>, <code>LOG_LEVEL</code>: Basic environment info.</li>
<li><code>OPERATOR_IMPORT</code>: Tells <code>main.py</code> to load the <code>GoogleErrorReprocessOperator</code>.</li>
<li><code>QUEUE_TOPIC_ERROR</code>: Itself, in case it needs to resubmit for retry after delay.</li>
<li><code>QUEUE_TOPIC_EMAIL_SEND</code>, <code>QUEUE_TOPIC_SLACK_SEND</code>: Topics for sending notifications.</li>
<li><code>QUEUE_TOPIC_PUBSUB_TO_BQ</code>: Topic for sending structured logs to BigQuery (via <code>var.queue_topic_pubsub_to_bq</code>).</li>
<li><code>BIGQUERY_DATASET_ERROR</code>, <code>BIGQUERY_TABLE_ERROR</code>: Target for error logging.</li>
<li><code>EMAIL_SENDER_ERROR</code>, <code>EMAIL_RECIPIENTS_ERROR</code>, <code>SLACK_CHANNELS_ERROR</code>: Notification details from <code>var.error_config</code>.</li>
</ul>
</li>
<li><code>event_trigger</code>: Configures the function to be triggered by messages published to the <code>google_pubsub_topic.error_reprocess.id</code> topic. <code>retry_policy = "RETRY_POLICY_RETRY"</code> means GCP will attempt redelivery on transient issues, but the operator logic handles application-level retries.</li>
<li><code>depends_on</code>: Ensures the source code zip and necessary topics exist before creating the function.</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/error.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;error_reprocess&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;error_reprocess&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error-reprocess&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Handles errors, retries, logging, and notifications.&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;error-handler&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span><span class="c1"> # Function name in main.py</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="c1"> # Adjust as needed</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="c1">   # Scale to zero when idle</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span><span class="c1"> # Max timeout for Gen2 PubSub functions</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.google.cloud.core.operator import GoogleErrorReprocessOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="c1">      # Self-reference for potential delayed retries</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Notification topics (defined in email.tf/slack.tf)</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_EMAIL_SEND</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_email_send.name</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_SLACK_SEND</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_slack_send.name</span>
<span class="c1">      # Topic for structured logging (passed in as variable)</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_PUBSUB_TO_BQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.queue_topic_pubsub_to_bq.name</span>
<span class="c1">      # Config from variables for the operator</span>
<span class="w">      </span><span class="na">BIGQUERY_DATASET_ERROR</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.error_config.bigquery.dataset</span>
<span class="w">      </span><span class="na">BIGQUERY_TABLE_ERROR</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.error_config.bigquery.table</span>
<span class="w">      </span><span class="na">EMAIL_SENDER_ERROR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.error_config.email.sender</span>
<span class="w">      </span><span class="na">EMAIL_RECIPIENTS_ERROR</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">(</span><span class="nv">var.error_config.email.recipients</span><span class="p">)</span><span class="c1"> # Pass list as JSON string</span>
<span class="w">      </span><span class="na">SLACK_CHANNELS_ERROR</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">(</span><span class="nv">var.error_config.slack.channels</span><span class="p">)</span><span class="c1">  # Pass list as JSON string</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # Add service account email if using non-default permissions</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">trigger_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span><span class="c1"> # Can be omitted to use function region</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span><span class="c1"> # Basic GCP retry for infrastructure issues</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span><span class="p">,</span>
<span class="c1">    # Ensure notification topics exist before error function depends on them</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_notification_email_send</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_notification_slack_send</span>
<span class="c1">    # var.queue_topic_pubsub_to_bq # Topic resource should be created outside the module</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="delaytf"><code>delay.tf</code></h3>
<ul>
<li>Defines the Delay function and its topic.</li>
<li>Structure is very similar to <code>error.tf</code>.</li>
<li><code>google_pubsub_topic "delay"</code>: Topic to send messages to when a delay is needed.</li>
<li><code>google_cloudfunctions2_function "delay"</code>:<ul>
<li><code>OPERATOR_IMPORT</code>: Set to load the <code>GoogleDelayOperator</code>.</li>
<li><code>QUEUE_TOPIC_ERROR</code>: Specifies where this function should send errors if it fails.</li>
<li><code>retry_policy = "RETRY_POLICY_DO_NOT_RETRY"</code>: This function's core job <em>is</em> delay/retry logic; standard GCP retries might interfere. Failures should likely go straight to the error topic.</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/delay.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;delay&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-delay&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;delay&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-delay&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Introduces delays into workflows (e.g., for retries, rate limiting).&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;delay-handler&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.google.cloud.core.operator import GoogleDelayOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span><span class="c1"> # Send errors here</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.delay.id</span>
<span class="c1">    # Usually, delay logic is precise; don&#39;t rely on GCP auto-retry here.</span>
<span class="c1">    # Errors should go to the main error handler via QUEUE_TOPIC_ERROR.</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_DO_NOT_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.delay</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span><span class="c1"> # Ensure error topic exists</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="redirecttf"><code>redirect.tf</code></h3>
<ul>
<li>Defines the Redirect function(s) and associated topics.</li>
<li>Includes two topics/functions (<code>redirect</code> and <code>redirect_medium</code>) potentially for different scaling/resource needs (e.g., <code>redirect_medium</code> has more memory <code>512Mi</code>). This allows routing redirection tasks based on expected fan-out load.</li>
<li><code>google_cloudfunctions2_function "redirect"</code> / <code>"redirect_medium"</code>:<ul>
<li><code>OPERATOR_IMPORT</code>: Loads the <code>GoogleRedirectOperator</code>.</li>
<li><code>QUEUE_TOPIC_ERROR</code>: Specifies the error topic.</li>
<li><code>retry_policy = "RETRY_POLICY_RETRY"</code>: Basic GCP retries are acceptable here.</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/redirect.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;redirect&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-redirect&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;redirect_medium&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-redirect-medium&quot;</span><span class="c1"> # Topic for potentially larger fan-outs</span>
<span class="p">}</span>


<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;redirect&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-redirect&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Redirects/fans-out a single message to multiple topics.&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;redirect-handler&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="c1"> # Lower default max instances, adjust if needed</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.google.cloud.core.operator import GoogleRedirectOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DEBUG&quot;</span><span class="c1"> # Often useful to debug redirection logic</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.redirect</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;redirect_medium&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-redirect-medium&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Redirects/fans-out (medium instance size).&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;redirect-handler-medium&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;512Mi&quot;</span><span class="c1"> # More memory than standard redirect</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.google.cloud.core.operator import GoogleRedirectOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DEBUG&quot;</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect_medium.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.redirect_medium</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="emailtf"><code>email.tf</code></h3>
<ul>
<li>Defines functions and topics for sending emails.</li>
<li>Separates topics/functions for regular notifications (<code>notification_email_send</code>) and error notifications (<code>error_notification_email_send</code>). This allows using different SMTP configurations (via Secret Manager secrets <code>smtp</code> vs <code>smtp_error</code>) or different scaling/retry policies if needed.</li>
<li><code>google_cloudfunctions2_function "notification_email_send"</code> / <code>"error_notification_email_send"</code>:<ul>
<li><code>OPERATOR_IMPORT</code>: Loads the <code>GoogleEmailSendOperator</code>.</li>
<li><code>SECRET_SMTP</code>: Environment variable expected by the operator to specify the <em>name</em> of the secret in GCP Secret Manager containing SMTP credentials (e.g., host, port, user, password). The module assumes secrets named <code>smtp</code> and <code>smtp_error</code> exist.</li>
<li><code>max_instance_count = 1</code>: Limits concurrency, often desirable for external notification systems to avoid rate limits or being flagged as spam.</li>
<li><code>retry_policy = "RETRY_POLICY_RETRY"</code>: Allows GCP retries for transient SMTP issues.</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/email.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-notification-email-send&quot;</span>
<span class="p">}</span>

<span class="c1"># Separate topic/function for error emails allows different config/scaling if needed</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;error_notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error-notification-email-send&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-notification-email-send&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Sends standard email notifications via configured SMTP secret (&#39;smtp&#39;).&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;email-notifier&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="c1"> # Limit concurrency for email sending</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="c1"> # Email sending should be quick</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.email.operator import GoogleEmailSendOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Operator expects secret name containing SMTP details (host, port, user, pass)</span>
<span class="w">      </span><span class="na">SECRET_SMTP</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;smtp&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # Requires permissions to access Secret Manager</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_email_send.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.notification_email_send</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;error_notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error-notification-email-send&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Sends error email notifications via configured SMTP secret (&#39;smtp_error&#39;).&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;email-error-notifier&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="c1"> # Limit concurrency</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span><span class="c1"> # Allow longer timeout for potential error handling delays</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.email.operator import GoogleEmailSendOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Use a potentially different secret for error emails</span>
<span class="w">      </span><span class="na">SECRET_SMTP</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;smtp_error&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_email_send.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_notification_email_send</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="slacktf"><code>slack.tf</code></h3>
<ul>
<li>Defines functions and topics for Slack notifications.</li>
<li>Includes separate topics/functions for standard (<code>notification_slack_send</code>) and error (<code>error_notification_slack_send</code>) messages, allowing different Slack App configurations/tokens (via secrets like <code>slack_alert</code>) if needed.</li>
<li>Adds a <code>slack_react</code> function/topic, presumably to add emoji reactions to messages, perhaps indicating processing status.</li>
<li><code>google_cloudfunctions2_function "notification_slack_send"</code> / <code>"error_notification_slack_send"</code> / <code>"slack_react"</code>:<ul>
<li><code>OPERATOR_IMPORT</code>: Loads <code>GoogleSlackSendOperator</code> or <code>GoogleSlackReactOperator</code>.</li>
<li>Environment variables point to the error topic. The operator likely expects Slack API tokens/details to be stored in Secret Manager (though the specific secret name isn't defined via env var here, the operator might have a default like <code>slack_alert</code> or <code>slack_token</code>).</li>
<li><code>max_instance_count = 1</code> and short timeouts are common for notification functions.</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/slack.tf</span><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-notification-slack-message-send&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;error_notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error-notification-slack-message-send&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_pubsub_topic&quot;</span><span class="w"> </span><span class="nv">&quot;slack_react&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-slack-react&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-notification-slack-send&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Sends standard Slack notifications via configured API secret.&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slack-notifier&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="c1"> # Limit concurrency for Slack API calls</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span><span class="c1"> # Generous timeout, but should be quick</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.slack.operator import GoogleSlackSendOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Operator likely expects a Secret Manager secret name via convention or another env var</span>
<span class="c1">      # e.g., SLACK_SECRET_NAME = &quot;slack_alert&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email # Needs Secret Manager access</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_slack_send.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.notification_slack_send</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>


<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;error_notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-error-notification-slack-send&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Sends error Slack notifications via configured API secret.&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slack-error-notifier&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;256Mi&quot;</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">540</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.slack.operator import GoogleSlackSendOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Operator likely expects a Secret Manager secret name</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_slack_send.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_notification_slack_send</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_cloudfunctions2_function&quot;</span><span class="w"> </span><span class="nv">&quot;slack_react&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.env}-slack-react&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Airless: Reacts to Slack messages (e.g., adds emojis).&quot;</span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;airless-role&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slack-reactor&quot;</span>
<span class="w">    </span><span class="s2">&quot;environment&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python312&quot;</span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;route&quot;</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.function_bucket.name</span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.zip_core.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;128Mi&quot;</span><span class="c1"> # Reactions likely need less memory</span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="c1">      # Should be very quick</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ENV</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.env</span>
<span class="w">      </span><span class="na">OPERATOR_IMPORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;from airless.slack.operator import GoogleSlackReactOperator&quot;</span>
<span class="w">      </span><span class="na">GCP_PROJECT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">      </span><span class="na">LOG_LEVEL</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_level</span>
<span class="w">      </span><span class="na">QUEUE_TOPIC_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="c1">      # Operator likely expects a Secret Manager secret name</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">    # service_account_email = google_service_account.airless_core.email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">event_type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google.cloud.pubsub.topic.v1.messagePublished&quot;</span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.slack_react.id</span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RETRY_POLICY_RETRY&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nv">google_storage_bucket_object.zip_core</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.slack_react</span><span class="p">,</span>
<span class="w">    </span><span class="nv">google_pubsub_topic.error_reprocess</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="outputtf"><code>output.tf</code></h3>
<ul>
<li>Defines the outputs of the module. These expose the names and IDs of the created resources, making them easily accessible for use in other parts of your Terraform configuration or for external reference.</li>
<li>Outputs include bucket names and Pub/Sub topic details (both <code>id</code> and <code>name</code>).</li>
</ul>
<div class="highlight"><span class="filename">modules/airless-core/output.tf</span><pre><span></span><code><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;bucket_datalake_raw_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Name of the raw data bucket.&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.datalake_raw.name</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;bucket_datalake_landing_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Name of the main landing bucket.&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.datalake_landing.name</span>
<span class="p">}</span>

<span class="c1"># Outputting PubSub Topics (ID is often needed for triggers/permissions, name for reference/env vars)</span>
<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_error&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Error reprocess queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_reprocess.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_delay&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Delay queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.delay.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.delay.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_redirect&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Redirect queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_redirect_medium&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Redirect medium queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect_medium.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.redirect_medium.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard notification email send queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_email_send.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_email_send.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_error_notification_email_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Error notification email send queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_email_send.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_email_send.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard notification Slack send queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_slack_send.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.notification_slack_send.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_error_notification_slack_send&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Error notification Slack send queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_slack_send.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.error_notification_slack_send.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;queue_slack_react&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Slack react queue details.&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.slack_react.id</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.slack_react.name</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Add other outputs as needed, e.g., service account emails if created within the module</span>
</code></pre></div>
<p>This comprehensive setup provides the foundational, reusable Airless core infrastructure on GCP, managed effectively with Terraform. Remember to create the necessary secrets (<code>smtp</code>, <code>smtp_error</code>, Slack tokens) in GCP Secret Manager and grant appropriate IAM permissions to the Cloud Functions' service accounts (especially for accessing Pub/Sub, Storage, Secret Manager, and potentially BigQuery).</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.instant.preview", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>